<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>地盤改良工事 施工写真管理アプリ</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6;
            color: #333;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }
        .section-title {
            font-size: 1.75rem; /* text-3xl */
            font-weight: 700; /* font-bold */
            color: #1f2937; /* text-gray-900 */
            margin-bottom: 1rem;
        }
        .input-group label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 600;
            color: #4b5563;
        }
        .input-group input,
        .input-group select,
        .input-group textarea {
            width: 100%;
            padding: 0.75rem;
            border: 1px solid #d1d5db;
            border-radius: 0.5rem; /* rounded-lg */
            box-shadow: 0 1px 2px 0 rgba(0, 0, 0, 0.05); /* shadow-sm */
            transition: all 0.2s ease-in-out;
        }
        .input-group input:focus,
        .input-group select:focus,
        .input-group textarea:focus {
            outline: none;
            border-color: #3b82f6; /* ring-blue-500 */
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.5); /* ring-2 */
        }
        .btn {
            padding: 0.75rem 1.5rem;
            border-radius: 0.5rem;
            font-weight: 600;
            cursor: pointer;
            transition: background-color 0.2s ease-in-out, transform 0.1s ease-in-out;
        }
        .btn-primary {
            background-color: #3b82f6; /* blue-600 */
            color: white;
        }
        .btn-primary:hover {
            background-color: #2563eb; /* blue-700 */
            transform: translateY(-1px);
        }
        .btn-secondary {
            background-color: #6b7280; /* gray-500 */
            color: white;
        }
        .btn-secondary:hover {
            background-color: #4b5563; /* gray-600 */
            transform: translateY(-1px);
        }
        .btn-danger {
            background-color: #ef4444; /* red-500 */
            color: white;
        }
        .btn-danger:hover {
            background-color: #dc2626; /* red-600 */
            transform: translateY(-1px);
        }
        .photo-card {
            border: 1px solid #e5e7eb;
            border-radius: 0.75rem; /* rounded-xl */
            overflow: hidden;
            background-color: white;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06); /* shadow-lg */
        }
        .photo-card img {
            width: 100%;
            height: 200px; /* Fixed height for consistency */
            object-fit: cover;
            border-top-left-radius: 0.75rem;
            border-top-right-radius: 0.75rem;
        }
        .photo-card canvas {
            width: 100%;
            height: 200px; /* Fixed height for consistency */
            object-fit: contain;
            border-top-left-radius: 0.75rem;
            border-top-right-radius: 0.75rem;
            background-color: #f9fafb; /* gray-50 */
        }
        .photo-preview-container {
            width: 100px; /* Fixed width for small preview */
            height: 60px; /* Fixed height for small preview */
            background-color: #e5e7eb; /* Light gray background */
            border-radius: 0.5rem;
            overflow: hidden;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .photo-preview-container img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        .message-box {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background-color: white;
            padding: 2rem;
            border-radius: 0.75rem;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            z-index: 1000;
            text-align: center;
        }
        .message-box button {
            margin-top: 1rem;
        }
        .overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 999;
            display: none;
        }
    </style>
</head>
<body class="bg-gray-100 p-4 sm:p-6 lg:p-8">
    <div class="container bg-white p-6 sm:p-8 rounded-xl shadow-2xl space-y-8">
        <h1 class="text-4xl font-extrabold text-center text-blue-700 mb-8">地盤改良工事 施工写真管理アプリ</h1>

        <div class="flex justify-end mb-4">
            <button id="clearDataBtn" class="btn btn-danger text-sm px-4 py-2">
                全データをクリア
            </button>
        </div>

        <div class="bg-blue-50 p-6 rounded-xl shadow-inner">
            <h2 class="section-title text-blue-800">基本情報</h2>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
                <div class="input-group">
                    <label for="siteName">現場名 (工事名)</label>
                    <input type="text" id="siteName" class="p-3 rounded-lg" placeholder="例: ○○邸地盤改良工事">
                </div>
                <div class="input-group">
                    <label for="workType">工種</label>
                    <input type="text" id="workType" class="p-3 rounded-lg" placeholder="例: 柱状改良工事">
                </div>
                <div class="input-group">
                    <label for="currentDate">日付 (撮影月日)</label>
                    <input type="date" id="currentDate" class="p-3 rounded-lg">
                </div>
                <div class="input-group">
                    <label for="companyName">施工会社</label>
                    <input type="text" id="companyName" class="p-3 rounded-lg" value="株式会社JFDエンジニアリング">
                </div>
                <div class="input-group">
                    <label for="designDimension">設計寸法</label>
                    <input type="text" id="designDimension" class="p-3 rounded-lg" placeholder="例: φ800 L=4.5m" value="φ600 L=m">
                </div>
                <div class="input-group md:col-span-2">
                    <label for="lotNumber">号棟/号地 (現在の作業号地)</label>
                    <div class="flex items-center gap-2">
                        <input type="text" id="lotNumber" list="lotNumberOptions" class="p-3 rounded-lg flex-grow" placeholder="例: A棟, 1号地 (空欄で単棟)">
                        <datalist id="lotNumberOptions"></datalist>
                        <button id="addLotNumberBtn" class="btn btn-secondary px-4 py-2 text-sm whitespace-nowrap">
                            号棟を追加
                        </button>
                    </div>
                    <p class="text-sm text-gray-600 mt-1">下の各工程で写真を選択する際、ここに現在の号棟/号地を入力してください。</p>
                </div>
            </div>
        </div>

        <hr class="border-t-2 border-gray-200 my-8">

        <div class="bg-yellow-50 p-6 rounded-xl shadow-inner">
            <h2 class="section-title text-yellow-800">工程リストの編集</h2>
            <p class="mb-4 text-gray-700">ここに表示したい工程リストを1行に1つずつ入力してください。保存すると、このリストが写真アップロードの工程として使用されます。</p>
            <textarea id="processListEditor" class="w-full p-3 rounded-lg border border-gray-300 min-h-[200px]" placeholder="例:&#10;施工前全景 1&#10;配置確認 1&#10;材料搬入"></textarea>
            <div class="flex flex-col sm:flex-row justify-center gap-4 mt-4">
                <button id="saveProcessListBtn" class="btn btn-primary bg-yellow-600 hover:bg-yellow-700">
                    リストを保存
                </button>
                <button id="resetProcessListBtn" class="btn btn-secondary">
                    デフォルトに戻す
                </button>
            </div>
        </div>

        <hr class="border-t-2 border-gray-200 my-8">

        <div class="bg-blue-50 p-6 rounded-xl shadow-inner">
            <h2 class="section-title text-blue-800">工程ごとの写真アップロード</h2>
            <p class="mb-4 text-gray-700">現在選択中の号棟/号地: <span id="currentLotDisplay" class="font-bold text-blue-700"></span><br>以下のリストから工程を選択し、該当する写真をアップロードしてください。<br>号棟/号地が異なる場合は、上の「号棟/号地」を変更してから写真を選択してください。</p>
            <div id="processUploadList" class="space-y-4">
            </div>
        </div>

        <hr class="border-t-2 border-gray-200 my-8">

        <div class="bg-gray-50 p-6 rounded-xl shadow-inner">
            <h2 class="section-title text-gray-800">登録済み写真一覧</h2>
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-6">
                <div class="input-group">
                    <label for="filterDate">日付で絞り込み</label>
                    <input type="date" id="filterDate" class="p-3 rounded-lg">
                </div>
                <div class="input-group">
                    <label for="filterProcess">工程で絞り込み</label>
                    <input type="text" id="filterProcess" list="processFilterOptions" class="p-3 rounded-lg" placeholder="例: 基礎地盤改良工">
                    <datalist id="processFilterOptions"></datalist>
                </div>
                <div class="input-group">
                    <label for="filterLotNumber">号棟/号地で絞り込み</label>
                    <input type="text" id="filterLotNumber" list="lotNumberFilterOptions" class="p-3 rounded-lg" placeholder="例: A棟">
                    <datalist id="lotNumberFilterOptions"></datalist>
                </div>
            </div>
            <div class="flex justify-center mb-6">
                <button id="resetFiltersBtn" class="btn btn-secondary">フィルターをリセット</button>
            </div>
            <div id="photoList" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-6">
            </div>
            <p id="noPhotosMessage" class="text-center text-gray-500 mt-8 hidden">
                写真がまだ登録されていません。上のセクションから写真を選択してください。
            </p>
        </div>

        <hr class="border-t-2 border-gray-200 my-8">

        <div class="bg-green-50 p-6 rounded-xl shadow-inner text-center">
            <h2 class="section-title text-green-800">データ出力</h2>
            <p class="text-gray-700 mb-6">現在表示されている写真データを出力します。</p>
            <div class="flex flex-col sm:flex-row justify-center gap-4">
                <button id="generatePdfBtn" class="btn btn-primary bg-green-600 hover:bg-green-700" style="display: none;">
                    PDFを生成
                </button>
                <button id="exportExcelBtn" class="btn btn-primary bg-green-600 hover:bg-green-700">
                    Excelを生成
                </button>
                <button id="downloadZipBtn" class="btn btn-primary bg-green-600 hover:bg-green-700">
                    全写真をZIPでダウンロード
                </button>
            </div>
        </div>
    </div>

    <div id="messageOverlay" class="overlay hidden"></div>
    <div id="messageBox" class="message-box hidden">
        <p id="messageText" class="mb-4 text-lg font-medium"></p>
        <button id="messageBoxCloseBtn" class="btn btn-primary">閉じる</button>
    </div>

    <div id="confirmOverlay" class="overlay hidden"></div>
    <div id="confirmBox" class="message-box hidden">
        <p id="confirmText" class="mb-4 text-lg font-medium"></p>
        <div class="flex justify-center gap-4">
            <button id="confirmYesBtn" class="btn btn-danger">はい</button>
            <button id="confirmNoBtn" class="btn btn-secondary">いいえ</button>
        </div>
    </div>


    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://unpkg.com/jspdf-autotable@3.5.16/dist/jspdf.plugin.autotable.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://unpkg.com/xlsx/dist/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.7.1/jszip.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>

    <script>
        // Global variables
        let photos = []; // Stores photo data
        let displayedPhotos = []; // Filtered and sorted photos for display and PDF

        // DOM Elements
        const siteNameInput = document.getElementById('siteName');
        const workTypeInput = document.getElementById('workType'); // 工種 input
        const currentDateInput = document.getElementById('currentDate');
        const companyNameInput = document.getElementById('companyName');
        const lotNumberInput = document.getElementById('lotNumber');
        const lotNumberDatalist = document.getElementById('lotNumberOptions');
        const designDimensionInput = document.getElementById('designDimension');
        const currentLotDisplay = document.getElementById('currentLotDisplay');

        const processListEditor = document.getElementById('processListEditor');
        const saveProcessListBtn = document.getElementById('saveProcessListBtn');
        const resetProcessListBtn = document.getElementById('resetProcessListBtn');
        const addLotNumberBtn = document.getElementById('addLotNumberBtn');

        const processUploadListDiv = document.getElementById('processUploadList');
        const photoListDiv = document.getElementById('photoList');
        const noPhotosMessage = document.getElementById('noPhotosMessage');
        const generatePdfBtn = document.getElementById('generatePdfBtn');
        const exportExcelBtn = document.getElementById('exportExcelBtn');
        const downloadZipBtn = document.getElementById('downloadZipBtn'); // New ZIP download button
        const clearDataBtn = document.getElementById('clearDataBtn');


        const filterDateInput = document.getElementById('filterDate');
        const filterProcessInput = document.getElementById('filterProcess');
        const processFilterDatalist = document.getElementById('processFilterOptions');
        const filterLotNumberInput = document.getElementById('filterLotNumber');
        const lotNumberFilterDatalist = document.getElementById('lotNumberFilterOptions');
        const resetFiltersBtn = document.getElementById('resetFiltersBtn');

        const messageOverlay = document.getElementById('messageOverlay');
        const messageBox = document.getElementById('messageBox');
        const messageText = document.getElementById('messageText');
        const messageBoxCloseBtn = document.getElementById('messageBoxCloseBtn');

        const confirmOverlay = document.getElementById('confirmOverlay');
        const confirmBox = document.getElementById('confirmBox');
        const confirmText = document.getElementById('confirmText');
        const confirmYesBtn = document.getElementById('confirmYesBtn');
        const confirmNoBtn = document.getElementById('confirmNoBtn');

        // Default predefined process list
        const defaultPredefinedProcesses = [
            "施工前全景 1", "施工前全景 2", "施工前全景 3",
            "配置確認 1", "配置確認 2", "配置確認 3",
            "地縄, 杭芯確認", "GL BM 確認",
            "材料搬入 合計 0.0 t", "材料搬入、1回目 0.0 t", "材料搬入 2回目 0.0 合計 0.0t",
            "材料搬入 3回目 0.0t 合計 0.0t (うち 0.0t を 0号地 で使用)", "材料伝票 確認",
            "ロッド検尺 全長 0.00m", "検尺 (攪拌ヘッド全景) φ000mm", "プラント設備全景", "施工機全景",
            "管理装置確認",
            "杭芯セット 杭 No.0", "据進状況 杭 No.0", "混合攪拌状況 杭 No.0", "残尺確認 杭 No.0", "打設完了 杭 No.0",
            "供試体採取状況", "供試体体採取",
            "杭頭処理後確認", "改良天端高確認", "通芯確認",
            "使用材料 空袋検収",
            "施工後全景 1", "施工後全景 2", "施工後全景 3",
            "道路清掃状況", "撤収前最終状況"
        ];
        let currentPredefinedProcesses = []; // This will be the mutable array holding the active process list

        let lotNumberOptions = new Set(); // To store unique lot numbers for datalists
        let confirmCallback = null; // Callback for custom confirmation dialog

        // Set current date as default
        currentDateInput.valueAsDate = new Date();

        // --- Event Listeners ---
        generatePdfBtn.addEventListener('click', generatePdf);
        exportExcelBtn.addEventListener('click', exportToExcel); // New Excel export button listener
        downloadZipBtn.addEventListener('click', downloadAllImagesAsZip); // New ZIP download button listener
        clearDataBtn.addEventListener('click', clearAllData); // New Clear data button listener
        messageBoxCloseBtn.addEventListener('click', hideMessageBox);

        confirmYesBtn.addEventListener('click', () => {
            if (confirmCallback) {
                confirmCallback(true);
            }
            hideConfirmBox();
        });
        confirmNoBtn.addEventListener('click', () => {
            if (confirmCallback) {
                confirmCallback(false);
            }
            hideConfirmBox();
        });


        filterDateInput.addEventListener('change', applyFilters);
        filterProcessInput.addEventListener('input', applyFilters);
        filterLotNumberInput.addEventListener('input', applyFilters);
        resetFiltersBtn.addEventListener('click', resetFilters);

        saveProcessListBtn.addEventListener('click', saveProcessList); // Save process list
        resetProcessListBtn.addEventListener('click', resetProcessListToDefault); // Reset process list

        addLotNumberBtn.addEventListener('click', addLotNumber); // Add lot number button listener

        // Update lot number datalists when lotNumberInput changes
        lotNumberInput.addEventListener('change', (e) => {
            // "単棟"はdatalistに追加しない
            const lotValue = e.target.value.trim();
            if (lotValue !== '' && !lotNumberOptions.has(lotValue)) {
                lotNumberOptions.add(lotValue);
                updateDatalist(lotNumberDatalist, lotNumberOptions);
                updateDatalist(lotNumberFilterDatalist, lotNumberOptions);
            }
            updateProcessUploadListPreviews(); // Refresh previews based on new lot number
            updateCurrentLotDisplay(); // Update the display text
            saveAppData(); // Save data on lotNumber change
        });
        lotNumberInput.addEventListener('input', updateProcessUploadListPreviews); // Also update on input for immediate feedback
        lotNumberInput.addEventListener('input', updateCurrentLotDisplay); // Also update display on input

        // Save data on basic info input changes
        siteNameInput.addEventListener('input', saveAppData);
        workTypeInput.addEventListener('input', saveAppData); // Save workType
        currentDateInput.addEventListener('change', saveAppData);
        companyNameInput.addEventListener('input', saveAppData);
        designDimensionInput.addEventListener('input', saveAppData);


        // --- Core Functions ---

        /**
         * Saves all relevant app data to local storage.
         */
        function saveAppData() {
            // Only save necessary photo data (processedSrc, originalSrc, and metadata)
            const serializablePhotos = photos.map(p => ({
                id: p.id,
                processedSrc: p.processedSrc,
                originalSrc: p.originalSrc, // ★★★ originalSrcも保存 ★★★
                siteName: p.siteName,
                date: p.date,
                process: p.process,
                companyName: p.companyName,
                lotNumber: p.lotNumber,
                fileName: p.fileName,
                timestamp: p.timestamp,
                designDimension: p.designDimension,
                photoSituation: p.photoSituation, // Save situation field
                workType: p.workType // Save workType field
            }));
            localStorage.setItem('photos', JSON.stringify(serializablePhotos));
            localStorage.setItem('lotNumberOptions', JSON.stringify(Array.from(lotNumberOptions)));
            localStorage.setItem('siteName', siteNameInput.value);
            localStorage.setItem('workType', workTypeInput.value); // Save workType
            localStorage.setItem('companyName', companyNameInput.value);
            localStorage.setItem('designDimension', designDimensionInput.value);
            localStorage.setItem('currentDate', currentDateInput.value);
            localStorage.setItem('lotNumber', lotNumberInput.value);
        }

        /**
         * Loads all relevant app data from local storage.
         */
        function loadAppData() {
            const savedPhotos = localStorage.getItem('photos');
            if (savedPhotos) {
                try {
                    photos = JSON.parse(savedPhotos);
                } catch (e) {
                    console.error("Error parsing saved photos:", e);
                    photos = [];
                    localStorage.removeItem('photos');
                }
            } else {
                photos = [];
            }

            const savedLotOptions = localStorage.getItem('lotNumberOptions');
            if (savedLotOptions) {
                try {
                    lotNumberOptions = new Set(JSON.parse(savedLotOptions));
                } catch (e) {
                    console.error("Error parsing saved lot options:", e);
                    lotNumberOptions = new Set();
                    localStorage.removeItem('lotNumberOptions');
                }
            } else {
                lotNumberOptions = new Set();
            }

            const savedSiteName = localStorage.getItem('siteName');
            if (savedSiteName) siteNameInput.value = savedSiteName;

            const savedWorkType = localStorage.getItem('workType'); // Load workType
            if (savedWorkType) workTypeInput.value = savedWorkType;

            const savedCompanyName = localStorage.getItem('companyName');
            if (savedCompanyName) companyNameInput.value = savedCompanyName;

            const savedDesignDimension = localStorage.getItem('designDimension');
            if (savedDesignDimension) designDimensionInput.value = savedDesignDimension;

            const savedCurrentDate = localStorage.getItem('currentDate');
            if (savedCurrentDate) currentDateInput.value = savedCurrentDate;

            const savedLotNumber = localStorage.getItem('lotNumber');
            if (savedLotNumber) lotNumberInput.value = savedLotNumber;

            // Load custom process list or use default
            const savedProcesses = loadProcessListFromLocalStorage();
            if (savedProcesses) {
                currentPredefinedProcesses = savedProcesses;
            } else {
                currentPredefinedProcesses = [...defaultPredefinedProcesses];
            }
            processListEditor.value = currentPredefinedProcesses.join('\n');

            // Initialize UI components after loading data
            updateDatalist(lotNumberDatalist, lotNumberOptions);
            updateDatalist(lotNumberFilterDatalist, lotNumberOptions);
            initializeProcessUploadList(); // This also updates processFilterDatalist
            applyFilters();
            updateCurrentLotDisplay(); // Ensure current lot display is updated on load
        }

        /**
         * Show message box
         * @param {string} message - Message to display
         */
        function showMessageBox(message) {
            messageText.textContent = message;
            messageOverlay.classList.remove('hidden');
            messageBox.classList.remove('hidden');
        }

        /**
         * Hide message box
         */
        function hideMessageBox() {
            messageOverlay.classList.add('hidden');
            messageBox.classList.add('hidden');
        }

        /**
         * Show custom confirmation box
         * @param {string} message - Confirmation message
         * @param {function(boolean): void} callback - Callback function (true for yes, false for no)
         */
        function showConfirmBox(message, callback) {
            confirmText.textContent = message;
            confirmCallback = callback;
            confirmOverlay.classList.remove('hidden');
            confirmBox.classList.remove('hidden');
        }

        /**
         * Hide custom confirmation box
         */
        function hideConfirmBox() {
            confirmOverlay.classList.add('hidden');
            confirmBox.classList.add('hidden');
            confirmCallback = null;
        }

        /**
         * Updates datalist options
         * @param {HTMLDatalistElement} datalistElement - The datalist element to update
         * @param {Set<string>} optionsSet - Set of options to add
         */
        function updateDatalist(datalistElement, optionsSet) {
            datalistElement.innerHTML = '';
            // "単棟"はdatalistには含めない
            optionsSet.forEach(option => {
                if (option !== '') { // Empty string means "単棟"
                    const optionElement = document.createElement('option');
                    optionElement.value = option;
                    datalistElement.appendChild(optionElement);
                }
            });
        }

        /**
         * Updates the display for the current lot number.
         */
        function updateCurrentLotDisplay() {
            const lotVal = lotNumberInput.value.trim();
            currentLotDisplay.textContent = lotVal === '' ? '単棟' : lotVal;
        }

        /**
         * Loads process list from Local Storage or uses default.
         * @returns {string[]} Loaded process list.
         */
        function loadProcessListFromLocalStorage() {
            const savedList = localStorage.getItem('customProcesses');
            if (savedList) {
                try {
                    const parsedList = JSON.parse(savedList);
                    if (Array.isArray(parsedList) && parsedList.every(item => typeof item === 'string')) {
                        return parsedList;
                    }
                } catch (e) {
                    console.error("Error parsing saved process list:", e);
                    localStorage.removeItem('customProcesses'); // Clear corrupted data
                }
            }
            return null; // No valid saved list
        }

        /**
         * Saves the current process list to Local Storage.
         * @param {string[]} list - The process list to save.
         */
        function saveProcessListToLocalStorage(list) {
            localStorage.setItem('customProcesses', JSON.stringify(list));
        }

        /**
         * Clears the process list from Local Storage.
         */
        function clearProcessListFromLocalStorage() {
            localStorage.removeItem('customProcesses');
        }

        /**
         * Saves the process list from the editor.
         */
        function saveProcessList() {
            const newProcesses = processListEditor.value.split('\n').map(p => p.trim()).filter(p => p !== '');
            if (newProcesses.length === 0) {
                showMessageBox('工程リストが空です。少なくとも1つの工程を入力してください。');
                return;
            }
            currentPredefinedProcesses = newProcesses;
            saveProcessListToLocalStorage(currentPredefinedProcesses);
            initializeProcessUploadList(); // Re-initialize with new list
            applyFilters(); // Re-apply filters for sorting
            showMessageBox('工程リストが保存されました！');
            saveAppData(); // Save all app data after process list change
        }

        /**
         * Resets the process list to default.
         */
        function resetProcessListToDefault() {
            showConfirmBox('工程リストをデフォルトに戻します。よろしいですか？\nこの操作は元に戻せません。', (confirmed) => {
                if (confirmed) {
                    currentPredefinedProcesses = [...defaultPredefinedProcesses];
                    clearProcessListFromLocalStorage();
                    processListEditor.value = currentPredefinedProcesses.join('\n'); // Update editor
                    initializeProcessUploadList(); // Re-initialize with default list
                    applyFilters(); // Re-apply filters for sorting
                    showMessageBox('工程リストがデフォルトに戻されました。');
                    saveAppData(); // Save all app data after process list change
                }
            });
        }

        /**
         * Initializes the dynamic list for process-guided photo upload.
         * Creates a row for each current predefined process with an upload button and a preview area.
         */
        function initializeProcessUploadList() {
            processUploadListDiv.innerHTML = '';
            currentPredefinedProcesses.forEach((processName, index) => {
                const processItemDiv = document.createElement('div');
                processItemDiv.className = 'flex flex-col sm:flex-row items-start sm:items-center gap-3 p-3 bg-white rounded-lg shadow-sm border border-gray-200';
                processItemDiv.innerHTML = `
                    <input type="text" value="${processName}" class="process-name-input font-semibold text-gray-800 flex-shrink-0 w-32 px-2 py-1 rounded-md border border-gray-300" data-process-index="${index}">
                    <div class="flex-grow flex flex-col gap-2">
                        <div class="flex gap-2">
                            <label for="photoUploadAlbum-${index}" class="btn btn-secondary cursor-pointer flex-grow px-4 py-2 text-sm rounded-md hover:bg-gray-600 text-center">
                                アルバムから選択
                            </label>
                            <label for="photoUploadCamera-${index}" class="btn btn-secondary cursor-pointer flex-grow px-4 py-2 text-sm rounded-md hover:bg-gray-600 text-center">
                                写真を撮影
                            </label>
                        </div>
                        <input type="text" id="photoSituation-${index}" class="photo-situation-input p-2 rounded-md border border-gray-300 text-sm" placeholder="状況/特記事項 (看板に表示)">
                        <div id="preview-${index}" class="photo-preview-container w-full h-16 bg-gray-100 rounded-md flex items-center justify-center text-gray-400 text-xs overflow-hidden">
                            <span class="text-center">写真なし</span>
                        </div>
                    </div>
                    <button class="remove-photo-btn btn btn-danger text-sm px-2 py-1 hidden" data-process-index="${index}">削除</button>
                    <input type="file" id="photoUploadAlbum-${index}" accept="image/*" class="hidden">
                    <input type="file" id="photoUploadCamera-${index}" accept="image/*" capture="environment" class="hidden">
                `; 
                processUploadListDiv.appendChild(processItemDiv);

                // Add event listener for process name input changes
                const processInput = processItemDiv.querySelector('.process-name-input');
                processInput.addEventListener('input', (e) => handleProcessNameChange(e, index));

                // Add event listener for photo situation input changes
                const situationInput = document.getElementById(`photoSituation-${index}`);
                situationInput.addEventListener('input', (e) => handlePhotoSituationChange(e, index));

                // Add event listeners for each photo upload input (Album and Camera)
                const photoInputAlbum = document.getElementById(`photoUploadAlbum-${index}`);
                photoInputAlbum.addEventListener('change', (e) => handleSinglePhotoUpload(e, index));

                const photoInputCamera = document.getElementById(`photoUploadCamera-${index}`);
                photoInputCamera.addEventListener('change', (e) => handleSinglePhotoUpload(e, index));

                // Add event listener for remove button
                const removeButton = processItemDiv.querySelector('.remove-photo-btn');
                removeButton.addEventListener('click', () => removePhotoForProcess(index));
            });
            // Update the filter datalist as well
            processFilterDatalist.innerHTML = '';
            currentPredefinedProcesses.forEach(p => processFilterDatalist.appendChild(new Option(p, p)));
            updateProcessUploadListPreviews(); // Initial update of previews
        }

        /**
         * Handles individual process name input changes.
         * @param {Event} event - The input event.
         * @param {number} index - The index of the process in currentPredefinedProcesses.
         */
        function handleProcessNameChange(event, index) {
            const newProcessName = event.target.value.trim();
            const oldProcessName = currentPredefinedProcesses[index];

            if (newProcessName === oldProcessName) {
                return; // No change
            }

            // Update the process name in currentPredefinedProcesses
            currentPredefinedProcesses[index] = newProcessName;

            // Update any photos that were associated with the old process name
            photos.forEach(photo => {
                if (photo.process === oldProcessName) {
                    photo.process = newProcessName;
                }
            });

            // Save the updated process list to local storage
            saveProcessListToLocalStorage(currentPredefinedProcesses);

            // Update the process list editor text area to reflect changes
            processListEditor.value = currentPredefinedProcesses.join('\n');

            // Re-apply filters to ensure photos are sorted and displayed correctly
            applyFilters();
            // Update the filter datalist options
            processFilterDatalist.innerHTML = '';
            currentPredefinedProcesses.forEach(p => processFilterDatalist.appendChild(new Option(p, p)));
            saveAppData(); // Save all app data after process name change
        }

        /**
         * Handles photo situation input changes.
         * This function updates the photoSituation for the currently selected lotNumber and process.
         * @param {Event} event - The input event.
         * @param {number} processIndex - The index of the photo in currentPredefinedProcesses.
         */
        function handlePhotoSituationChange(event, processIndex) {
            const newSituation = event.target.value.trim();
            const currentLotNumber = lotNumberInput.value.trim() === '' ? '' : lotNumberInput.value.trim();
            const processName = currentPredefinedProcesses[processIndex];

            // Find the specific photo to update
            const photoToUpdate = photos.find(p => p.process === processName && p.lotNumber === currentLotNumber);

            if (photoToUpdate) {
                photoToUpdate.photoSituation = newSituation;
                saveAppData(); // Save changes to local storage
            }
        }

        /**
         * Updates the photo previews in the process upload list based on the current lot number.
         * This ensures that when the user changes the lot number, they see photos for that specific lot.
         */
        function updateProcessUploadListPreviews() {
            const currentLotNumber = lotNumberInput.value.trim() === '' ? '' : lotNumberInput.value.trim(); // Handle "単棟"
            currentPredefinedProcesses.forEach((processName, index) => {
                // Get elements using querySelector on the parent div, which is more robust
                const processItemDiv = processUploadListDiv.children[index];
                if (!processItemDiv) {
                    console.warn(`Warning: processItemDiv is null for index ${index}. ProcessName: ${processName}. Skipping preview update for this item.`);
                    return; // Skip if the parent div isn't found
                }

                const previewContainer = processItemDiv.querySelector(`#preview-${index}`);
                const removeButton = processItemDiv.querySelector('.remove-photo-btn');
                const situationInput = processItemDiv.querySelector(`#photoSituation-${index}`);


                // Ensure all elements are found before proceeding
                if (!previewContainer || !removeButton || !situationInput) {
                    console.error(`Error: One or more elements not found for index ${index}. Preview: ${!!previewContainer}, RemoveBtn: ${!!removeButton}, SituationInput: ${!!situationInput}`);
                    return; // Skip if any required element is missing
                }

                // Find the photo for this process and the *current* lot number
                const photoForProcess = photos.find(p => p.process === processName && p.lotNumber === currentLotNumber);

                if (photoForProcess) {
                    previewContainer.innerHTML = `<img src="${photoForProcess.processedSrc}" class="w-full h-full object-cover rounded-md" data-photo-id="${photoForProcess.id}">`;
                    previewContainer.classList.remove('justify-center', 'text-gray-400');
                    removeButton.classList.remove('hidden');
                    situationInput.value = photoForProcess.photoSituation || ''; // Populate situation input
                } else {
                    previewContainer.innerHTML = '<span class="text-center">写真なし</span>';
                    previewContainer.classList.add('justify-center', 'text-gray-400');
                    removeButton.classList.add('hidden');
                    situationInput.value = ''; // Clear situation input if no photo
                }
            });
        }

        /**
         * Handles single photo upload for a specific process.
         * @param {Event} event - Change event from file input
         * @param {number} processIndex - The index of the process in currentPredefinedProcesses.
         */
        async function handleSinglePhotoUpload(event, processIndex) {
            const file = event.target.files[0];
            if (!file) return;

            const siteName = siteNameInput.value || '未入力現場';
            const workType = workTypeInput.value || '未入力工種'; // Get workType
            const date = currentDateInput.value;
            const companyName = companyNameInput.value || '株式会社JFDエンジニアリング'; // Default
            const lotNumber = lotNumberInput.value.trim() === '' ? '' : lotNumberInput.value.trim(); // Handle "単棟"
            const designDimension = designDimensionInput.value || 'φ600 L=m'; // Default

            // Get the current process name from the array using the index
            const processName = currentPredefinedProcesses[processIndex];
            const photoSituation = document.getElementById(`photoSituation-${processIndex}`).value || ''; // Get situation from its input


            // Input validation
            if (!date) {
                showMessageBox('日付が入力されていません。日付を選択してください。');
                event.target.value = ''; // Reset input to allow re-selection
                return;
            }

            // Add lot number to datalists if new and not empty (not "単棟" implicit)
            if (lotNumber !== '' && !lotNumberOptions.has(lotNumber)) {
                lotNumberOptions.add(lotNumber);
                updateDatalist(lotNumberDatalist, lotNumberOptions);
                updateDatalist(lotNumberFilterDatalist, lotNumberOptions); 
            }

            // Remove existing photo for this process and lot number before adding new one
            const existingPhotoIndex = photos.findIndex(p => p.process === processName && p.lotNumber === lotNumber);
            if (existingPhotoIndex !== -1) {
                photos.splice(existingPhotoIndex, 1);
            }

            // Generate file name including lot number if not empty
            // This fileName is used for internal reference and Excel export, not for ZIP.
            const lotSuffix = lotNumber === '' ? '' : `_${lotNumber.replace(/[^a-zA-Z0-9_]/g, '')}`;
            const baseFileName = `${processName.replace(/[^a-zA-Z0-9_]/g, '')}_${date}_${siteName.replace(/[^a-zA-Z0-9_]/g, '')}${lotSuffix}`;

            const reader = new FileReader();
            reader.onload = async (e) => {
                const originalSrc = e.target.result; // これが元の画像データ
                const id = crypto.randomUUID();

                const processedSrc = await drawSignboardOnImage(originalSrc, {
                    siteName, workType, date, process: processName, companyName, lotNumber, designDimension, photoSituation // Pass workType
                });

                photos.push({
                    id: id,
                    processedSrc: processedSrc, // This is the image with signboard, ready for display/PDF
                    originalSrc: originalSrc, // ★★★ 元の画像データも保存 ★★★
                    siteName: siteName,
                    workType: workType, // Store workType
                    date: date,
                    process: processName,
                    companyName: companyName,
                    lotNumber: lotNumber, // Store as empty string for "単棟"
                    fileName: baseFileName, // Keep this for Excel export and internal reference
                    timestamp: new Date(date).getTime(),
                    designDimension: designDimension,
                    photoSituation: photoSituation // Store situation with photo
                });

                updateProcessUploadListPreviews(); // Refresh all previews (especially current one)
                applyFilters(); // Re-render the main photo list (now ordered)
                saveAppData(); // Save all app data after photo upload
            };
            reader.readAsDataURL(file);

            event.target.value = ''; // Reset file input to allow uploading same file again if needed
        }

        /**
         * Removes a photo associated with a specific process index and the current lot number.
         * @param {number} processIndex - Index of the process in currentPredefinedProcesses
         */
        function removePhotoForProcess(processIndex) {
            const processName = currentPredefinedProcesses[processIndex]; // Get the current process name
            const currentLotNumber = lotNumberInput.value.trim() === '' ? '' : lotNumberInput.value.trim(); // Handle "単棟"

            const lotDisplay = currentLotNumber === '' ? '単棟' : currentLotNumber;
            showConfirmBox(`工程「${processName}」の現在の号地「${lotDisplay}」の写真を削除します。よろしいですか？`, (confirmed) => {
                if (confirmed) {
                    const photoToRemoveIndex = photos.findIndex(p => p.process === processName && p.lotNumber === currentLotNumber);
                    if (photoToRemoveIndex !== -1) {
                        photos.splice(photoToRemoveIndex, 1);
                        updateProcessUploadListPreviews(); // Refresh previews
                        applyFilters(); // Re-render the main photo list
                        saveAppData(); // Save data after removal
                        showMessageBox('写真を削除しました。');
                    } else {
                        showMessageBox('この工程と号地の写真はありません。');
                    }
                }
            });
        }

        /**
         * Draws signboard text onto an image and returns a Data URL.
         * This version is based on image_713113.jpg and user's specific layout requests.
         * @param {object} signboardData - Signboard information (siteName, workType, date, process, companyName, lotNumber, designDimension, photoSituation)
         * @returns {Promise<string>} Data URL of the image with signboard
         */
        async function drawSignboardOnImage(imgSrc, signboardData) {
            return new Promise((resolve) => {
                const img = new Image();
                img.onload = () => {
                    const canvas = document.createElement('canvas');
                    const ctx = canvas.getContext('2d');

                    // Adjust canvas size to maintain aspect ratio while fitting within a max height for processing
                    const maxHeight = 800; // Increased max height for better quality
                    let width = img.width;
                    let height = img.height;

                    if (height > maxHeight) {
                        width *= maxHeight / height;
                        height = maxHeight;
                    }
                    canvas.width = width;
                    canvas.height = height;

                    ctx.drawImage(img, 0, 0, width, height);

                    // Signboard styling (green background, white text)
                    const signboardColor = 'rgb(70, 140, 100)'; // 少し彩度を落とした緑
                    const textColor = '#FFFFFF';

                    // Signboard size (current 0.7 * 0.55 = 0.385 times the current size)
                    // 元のイメージの0.58/0.48比率を維持しつつ、画像全体の幅に対する割合を0.55に設定
                    const signboardRelativeWidth = 0.58 * 0.55; 
                    const signboardRelativeHeight = 0.48 * 0.55; 

                    const signboardWidth = width * signboardRelativeWidth;
                    const signboardHeight = height * signboardRelativeHeight;

                    // Position signboard at bottom right with padding
                    const paddingX = width * 0.02;
                    const paddingY = height * 0.02;
                    const signboardX = width - signboardWidth - paddingX;
                    const signboardY = height - signboardHeight - paddingY;

                    // Draw signboard background
                    ctx.fillStyle = signboardColor;
                    ctx.fillRect(signboardX, signboardY, signboardWidth, signboardHeight);

                    // --- Internal Layout based on latest image_713113.jpg and specific requirements ---
                    // Row 1: 工事名
                    // Row 2: 日付
                    // Row 3: 工種 (left), 設計寸法 (right)
                    // Row 4: 工程 (large text)
                    // Row 5: 株式会社JFDエンジニアリング (left-aligned)

                    // Calculate row heights
                    const row1Height = signboardHeight * 0.15; // 工事名
                    const row2Height = signboardHeight * 0.15; // 日付
                    const row3Height = signboardHeight * 0.15; // 工種 & 設計寸法
                    const row5Height = signboardHeight * 0.15; // 会社名
                    const processRowHeight = signboardHeight - (row1Height + row2Height + row3Height + row5Height); // 工程 (remaining height)


                    ctx.strokeStyle = textColor; // Lines are white
                    ctx.lineWidth = 1;
                    ctx.beginPath();
                    // Horizontal lines for each section
                    ctx.moveTo(signboardX, signboardY + row1Height); // After 工事名
                    ctx.lineTo(signboardX + signboardWidth, signboardY + row1Height);
                    ctx.moveTo(signboardX, signboardY + row1Height + row2Height); // After 日付
                    ctx.lineTo(signboardX + signboardWidth, signboardY + row1Height + row2Height);
                    ctx.moveTo(signboardX, signboardY + row1Height + row2Height + row3Height); // After 工種/設計寸法
                    ctx.lineTo(signboardX + signboardWidth, signboardY + row1Height + row2Height + row3Height);
                    ctx.moveTo(signboardX, signboardY + row1Height + row2Height + row3Height + processRowHeight); // After 工程
                    ctx.lineTo(signboardX + signboardWidth, signboardY + row1Height + row2Height + row3Height + processRowHeight);
                    
                    // Vertical line between 工種 and 設計寸法
                    const verticalDividerX = signboardX + signboardWidth * 0.5; // Roughly half way for vertical split
                    ctx.moveTo(verticalDividerX, signboardY + row1Height + row2Height);
                    ctx.lineTo(verticalDividerX, signboardY + row1Height + row2Height + row3Height);
                    ctx.stroke();

                    // Text styling
                    ctx.fillStyle = textColor;
                    ctx.textBaseline = 'middle'; // Align text vertically in the middle of its line

                    // Helper to draw text adapting to width, allowing bold
                    const drawTextAdapting = (text, x, y, maxWidth, initialFontSize, align = 'left', fontWeight = 'normal') => {
                        ctx.textAlign = align;
                        ctx.font = `${fontWeight} ${initialFontSize}px 'Inter', sans-serif`;
                        let currentText = text;
                        let textMetrics = ctx.measureText(currentText);

                        while (textMetrics.width > maxWidth && currentText.length > 0) {
                            currentText = currentText.slice(0, -1);
                            textMetrics = ctx.measureText(currentText);
                        }
                        if (currentText.length < text.length) {
                            currentText += '...';
                        }
                        ctx.fillText(currentText, x, y);
                    };

                    const textPadding = signboardWidth * 0.03; // General padding inside signboard

                    // 工事名 (Project Name) - Row 1
                    const projectNameY = signboardY + row1Height * 0.5;
                    drawTextAdapting(`工事名 ${signboardData.siteName}`, signboardX + textPadding, projectNameY, signboardWidth * 0.94, row1Height * 0.45, 'left', 'bold');

                    // 日付 (Date) - Row 2
                    const dateY = signboardY + row1Height + row2Height * 0.5;
                    drawTextAdapting(`日付 ${signboardData.date}`, signboardX + textPadding, dateY, signboardWidth * 0.94, row2Height * 0.45);

                    // 工種 (Work Type) - Row 3 Left
                    const workTypeY = signboardY + row1Height + row2Height + row3Height * 0.5;
                    const workTypeLabel = "工種";
                    const workTypeValue = signboardData.workType;
                    drawTextAdapting(`${workTypeLabel} ${workTypeValue}`, signboardX + textPadding, workTypeY, verticalDividerX - (signboardX + textPadding), row3Height * 0.45);

                    // 設計寸法 (Design Dimension) - Row 3 Right
                    const designDimY = workTypeY; // Same Y as工種
                    const designDimValue = signboardData.designDimension;
                    drawTextAdapting(`${designDimValue}`, verticalDividerX + textPadding, designDimY, signboardWidth - (verticalDividerX - signboardX) - textPadding, row3Height * 0.45); // Value only

                    // 工程 (Process) - Large Area (15% smaller)
                    const processValue = signboardData.process;
                    const processFontSize = processRowHeight * 0.51; // 0.6 * 0.85 = 0.51 (15% smaller)
                    const processY = signboardY + row1Height + row2Height + row3Height + processRowHeight * 0.5;
                    // Adjust font size dynamically to ensure text fits
                    let currentProcessFontSize = processFontSize;
                    ctx.font = `bold ${currentProcessFontSize}px 'Inter', sans-serif`;
                    let textWidth = ctx.measureText(processValue).width;
                    const maxProcessTextWidth = signboardWidth * 0.94; // 94% of signboard width

                    while (textWidth > maxProcessTextWidth && currentProcessFontSize > 10) { // Don't go too small
                        currentProcessFontSize -= 1;
                        ctx.font = `bold ${currentProcessFontSize}px 'Inter', sans-serif`;
                        textWidth = ctx.measureText(processValue).width;
                    }
                    drawTextAdapting(processValue, signboardX + signboardWidth / 2, processY, maxProcessTextWidth, currentProcessFontSize, 'center', 'bold'); // Centered and bold

                    // 株式会社JFDエンジニアリング (Company Name) - Bottom Row
                    const companyNameValue = signboardData.companyName;
                    const companyNameFontSize = row5Height * 0.45; // Similar size to 工事名, just value
                    const companyNameY = signboardY + row1Height + row2Height + row3Height + processRowHeight + row5Height * 0.5;
                    drawTextAdapting(companyNameValue, signboardX + textPadding, companyNameY, signboardWidth * 0.94, companyNameFontSize, 'left', 'bold'); // Left-aligned and bold


                    resolve(canvas.toDataURL('image/jpeg', 0.9)); // JPEG format with 0.9 quality
                };
                img.src = imgSrc;
            });
        }

        /**
         * Filters and sorts the photo list for display and PDF generation.
         * Sorting order: 1. Process Index (predefined order), 2. Lot Number, 3. Date.
         */
        function applyFilters() {
            const filterDate = filterDateInput.value;
            const filterProcess = filterProcessInput.value.toLowerCase();
            const filterLotNumber = filterLotNumberInput.value.toLowerCase();

            let filtered = [...photos];

            // Apply date filter
            if (filterDate) {
                filtered = filtered.filter(photo => photo.date === filterDate);
            }
            // Apply process filter
            if (filterProcess) {
                filtered = filtered.filter(photo => photo.process.toLowerCase().includes(filterProcess));
            }
            // Apply lot number filter (handle empty string for "単棟")
            if (filterLotNumber !== '') { // If filter is not empty
                filtered = filtered.filter(photo => photo.lotNumber.toLowerCase().includes(filterLotNumber));
            }


            // Sort photos: 1. By current predefined process order, 2. By Lot Number, 3. By Date
            filtered.sort((a, b) => {
                // Primary sort: Process Order based on currentPredefinedProcesses
                const aProcessOrder = currentPredefinedProcesses.indexOf(a.process);
                const bProcessOrder = currentPredefinedProcesses.indexOf(b.process);

                // Handle processes not found in currentPredefinedProcesses (e.g., put them at the end)
                const finalAOrder = aProcessOrder !== -1 ? aProcessOrder : 9999;
                const finalBOrder = bProcessOrder !== -1 ? bProcessOrder : 9999;

                if (finalAOrder !== finalBOrder) {
                    return finalAOrder - finalBOrder;
                }
                // Secondary sort: Lot Number (handle empty string for "単棟" to appear first)
                const lotA = a.lotNumber === '' ? '単棟' : a.lotNumber;
                const lotB = b.lotNumber === '' ? '単棟' : b.lotNumber;
                if (lotA.localeCompare(lotB, 'ja', { numeric: true, sensitivity: 'base' }) !== 0) {
                    return lotA.localeCompare(lotB, 'ja', { numeric: true, sensitivity: 'base' });
                }
                // Tertiary sort: Date
                return a.timestamp - b.timestamp;
            });

            displayedPhotos = filtered; // Update photos for display
            renderPhotoList(); // Re-render the UI
        }

        /**
         * Resets all filters.
         */
        function resetFilters() {
            filterDateInput.value = '';
            filterProcessInput.value = '';
            filterLotNumberInput.value = '';
            applyFilters();
        }

        /**
         * Renders the main photo list UI.
         */
        function renderPhotoList() {
            photoListDiv.innerHTML = ''; // Clear existing elements
            if (displayedPhotos.length === 0) {
                noPhotosMessage.classList.remove('hidden');
                return;
            } else {
                noPhotosMessage.classList.add('hidden');
            }

            displayedPhotos.forEach((photo, index) => {
                const photoCard = document.createElement('div');
                photoCard.className = 'photo-card p-4 flex flex-col items-center justify-between space-y-3';
                photoCard.setAttribute('data-id', photo.id); // Keep ID as data attribute

                // Display the canvas (image with signboard)
                const canvas = document.createElement('canvas');
                canvas.width = 400; // Preview size
                canvas.height = 200;
                const ctx = canvas.getContext('2d');
                const img = new Image();
                img.onload = () => {
                    // Draw image scaled to fit canvas while maintaining aspect ratio
                    const aspectRatio = img.width / img.height;
                    let drawWidth = canvas.width;
                    let drawHeight = canvas.height;

                    if (drawWidth / aspectRatio > drawHeight) {
                        drawWidth = drawHeight * aspectRatio;
                    } else {
                        drawHeight = drawWidth / aspectRatio;
                    }
                    ctx.drawImage(img, (canvas.width - drawWidth) / 2, (canvas.height - drawHeight) / 2, drawWidth, drawHeight);
                };
                img.src = photo.processedSrc;
                photoCard.appendChild(canvas);

                const infoDiv = document.createElement('div');
                infoDiv.className = 'text-center w-full';
                const lotDisplay = photo.lotNumber === '' ? '単棟' : photo.lotNumber;
                infoDiv.innerHTML = `
                    <p class="font-bold text-lg">${photo.siteName}</p>
                    <p class="text-sm text-gray-600">工種: ${photo.workType}</p>
                    <p class="text-sm text-gray-600">工程: ${photo.process}</p>
                    <p class="text-sm text-gray-600">状況: ${photo.photoSituation}</p>
                    <p class="text-sm text-gray-600">号棟/号地: ${lotDisplay}</p>
                    <p class="text-sm text-gray-600">設計寸法: ${photo.designDimension}</p>
                    <p class="text-xs text-gray-400 mt-1">ファイル名: ${photo.fileName}_${index + 1}</p>
                `;
                photoCard.appendChild(infoDiv);

                const deleteButton = document.createElement('button');
                deleteButton.textContent = '削除';
                deleteButton.className = 'btn btn-danger text-sm px-3 py-1 mt-2';
                deleteButton.onclick = () => deletePhoto(photo.id);
                photoCard.appendChild(deleteButton);

                photoListDiv.appendChild(photoCard);
            });
        }

        /**
         * Deletes a photo from the list.
         * @param {string} id - ID of the photo to delete
         */
        function deletePhoto(id) {
            showConfirmBox('この写真をリストから削除します。よろしいですか？', (confirmed) => {
                if (confirmed) {
                    photos = photos.filter(photo => photo.id !== id);
                    updateProcessUploadListPreviews(); // Update previews as well
                    applyFilters(); // Re-render the list after deletion
                    saveAppData(); // Save data after deletion
                    showMessageBox('写真を削除しました。');
                }
            });
        }

        /**
         * Generates the PDF report.
         */
        async function generatePdf() {
            if (displayedPhotos.length === 0) {
                showMessageBox('PDFを生成する写真がありません。');
                return;
            }

            showMessageBox('PDFを生成しています。しばらくお待ちください...');
            generatePdfBtn.disabled = true;
            exportExcelBtn.disabled = true;
            downloadZipBtn.disabled = true;

            const { jsPDF } = window.jspdf;
            const doc = new jsPDF('p', 'mm', 'a4'); // Portrait, millimeters, A4 size

            // Important: Load a Japanese font for PDF if not using a system font that supports Japanese.
            // This is a common point of failure for Japanese characters.
            // For a robust solution, you would typically use a library like `jspdf-html2canvas` for more complex layouts
            // or provide a base64 encoded font that is guaranteed to work across environments.
            // For this example, if the user's browser/OS does not have a suitable font, characters may appear as blocks.
            // A common workaround is to use `doc.addFont` with Base64 encoded font data.
            // Example for Noto Sans JP (needs a very large Base64 string):
            // doc.addFile(Base64FontDataHere, 'NotoSansJP', 'normal');
            // doc.setFont('NotoSansJP', 'normal');

            // As we are sticking to "工程: [工程名]" and to avoid large Base64,
            // we will simply try to use a generic serif/sans-serif,
            // or a common font that *might* exist like 'sans-serif'.
            // If actual garbling persists, true font embedding (with external data) is needed.
            doc.setFont('helvetica', 'normal'); 


            const pageWidth = doc.internal.pageSize.getWidth();
            const pageHeight = doc.internal.pageSize.getHeight();
            const margin = 10; // Page margin (mm)

            // PDF photo width and right-side text area calculation
            const pdfPhotoWidth = (pageWidth - margin * 3) / 2; // Photo takes half of the available width, leaving space for text
            const pdfTextWidth = (pageWidth - margin * 3) / 2; // Text area takes the other half
            const photoHeight = 60; // Fixed height for each photo in PDF (mm)
            const textLineHeight = 4; // Height of each text line in description (mm) - slightly smaller for more lines
            const spacing = 5; // Spacing between photo blocks (mm)

            let currentY = margin;
            let photosAddedOnPage = 0;

            for (let i = 0; i < displayedPhotos.length; i++) {
                const photo = displayedPhotos[i];

                // Calculate required height for the current photo block
                const requiredHeightForPhotoBlock = photoHeight + spacing;

                // Check if adding the next photo would overflow the current page. If so, add a new page.
                if (currentY + requiredHeightForPhotoBlock > pageHeight - margin && photosAddedOnPage > 0) {
                    doc.addPage();
                    currentY = margin;
                    photosAddedOnPage = 0;
                }

                try {
                    // Load image with signboard
                    const img = new Image();
                    img.src = photo.processedSrc;
                    await new Promise((resolve, reject) => {
                        img.onload = resolve;
                        img.onerror = (e) => {
                            console.error(`Error loading image for PDF: ${photo.fileName}`, e);
                            reject(e); // Reject the promise on error
                        };
                    });

                    // Calculate image dimensions to fit PDF width while maintaining aspect ratio
                    const aspectRatio = img.width / img.height;
                    let imgWidthPdf = pdfPhotoWidth;
                    let imgHeightPdf = pdfPhotoWidth / aspectRatio;

                    if (imgHeightPdf > photoHeight) { // If calculated height exceeds max photoHeight, scale down
                        imgHeightPdf = photoHeight;
                        imgWidthPdf = photoHeight * aspectRatio;
                    }

                    // Add image to PDF, left-aligned
                    doc.addImage(photo.processedSrc, 'JPEG', margin, currentY, imgWidthPdf, imgHeightPdf);

                    // --- Photo Description on the right side of the photo ---
                    // Only show "工程" for stable Japanese text display
                    doc.setFontSize(10);
                    // Use a generic font that should be available on most systems.
                    // This might still show garbled Japanese characters depending on the PDF viewer's font support.
                    doc.setFont('helvetica', 'normal'); 

                    const textX = margin + pdfPhotoWidth + margin; // Right of photo + a margin
                    const textY = currentY + (imgHeightPdf / 2); // Center vertically next to the image

                    doc.text(`工程: ${photo.process}`, textX, textY, { align: 'left', baseline: 'middle' });


                } catch (error) {
                    console.error(`Failed to add photo ${photo.fileName} to PDF:`, error);
                    showMessageBox(`写真「${photo.fileName}」のPDFへの追加中にエラーが発生しました。詳細はコンソールを確認してください。この写真を除いてPDF生成を続行します。`);
                }

                currentY += photoHeight + spacing; // Always advance Y based on photo height, even if drawing failed
                photosAddedOnPage++;
            }

            const fileName = `施工写真_${currentDateInput.value || '日付不明'}_${siteNameInput.value || '現場名不明'}.pdf`;
            doc.save(fileName); // Save the PDF

            hideMessageBox();
            showMessageBox('PDFの生成が完了しました！');
            generatePdfBtn.disabled = false;
            exportExcelBtn.disabled = false;
            downloadZipBtn.disabled = false;
        }

        /**
         * Exports photo data to an Excel file.
         */
        async function exportToExcel() {
            if (displayedPhotos.length === 0) {
                showMessageBox('エクセル出力する写真データがありません。');
                return;
            }

            showMessageBox('エクセルデータを生成しています。しばらくお待ちください...');
            generatePdfBtn.disabled = true;
            exportExcelBtn.disabled = true;
            downloadZipBtn.disabled = true;

            const data = [];
            // Header row
            data.push([
                '工事名', '工種', '撮影月日', '工程', '号棟/号地', '設計寸法', '状況/特記事項', 'ファイル名'
            ]);

            // Data rows
            displayedPhotos.forEach(photo => {
                const lotDisplay = photo.lotNumber === '' ? '単棟' : photo.lotNumber;
                data.push([
                    photo.siteName,
                    photo.workType,
                    photo.date,
                    photo.process,
                    lotDisplay,
                    photo.designDimension,
                    photo.photoSituation,
                    photo.fileName // Use the original fileName stored for Excel
                ]);
            });

            const ws = XLSX.utils.aoa_to_sheet(data); // Array of arrays to sheet
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, "施工写真データ"); // Sheet name

            const fileName = `施工写真データ_${currentDateInput.value || '日付不明'}_${siteNameInput.value || '現場名不明'}.xlsx`;
            XLSX.writeFile(wb, fileName);

            hideMessageBox();
            showMessageBox('エクセルデータの生成が完了しました！');
            generatePdfBtn.disabled = false;
            exportExcelBtn.disabled = false;
            downloadZipBtn.disabled = false;
        }

        /**
         * Downloads all processed images as a ZIP file.
         */
        async function downloadAllImagesAsZip() {
            if (photos.length === 0) {
                showMessageBox('ダウンロードする写真がありません。');
                return;
            }

            showMessageBox('ZIPファイルを生成しています。しばらくお待ちください...');
            generatePdfBtn.disabled = true;
            exportExcelBtn.disabled = true;
            downloadZipBtn.disabled = true;

            const zip = new JSZip();
            const originalImgFolder = zip.folder("施工写真_オリジナル"); // オリジナル画像用フォルダ
            const processedImgFolder = zip.folder("施工写真_看板付き"); // 看板付き画像用フォルダ

            // Sort photos by process order and lot number to ensure consistent numbering
            const sortedPhotos = [...photos].sort((a, b) => {
                const aProcessOrder = currentPredefinedProcesses.indexOf(a.process);
                const bProcessOrder = currentPredefinedProcesses.indexOf(b.process);

                if (aProcessOrder !== bProcessOrder) {
                    return aProcessOrder - bProcessOrder;
                }
                // Secondary sort: Lot Number (handle empty string for "単棟" to appear first)
                const lotA = a.lotNumber === '' ? '単棟' : a.lotNumber;
                const lotB = b.lotNumber === '' ? '単棟' : b.lotNumber;
                return lotA.localeCompare(lotB, 'ja', { numeric: true, sensitivity: 'base' });
            });

            // For tracking unique file names to append a counter if needed
            const generatedFileNames = {};

            for (const photo of sortedPhotos) {
                try {
                    // Generate filename based on process index and cleaned process name
                    // Get the index (0-based) and add 1 for the sequence number
                    const processIndex = currentPredefinedProcesses.indexOf(photo.process);
                    let sequenceNumber = processIndex !== -1 ? (processIndex + 1) : 999; // Fallback for unknown processes
                    sequenceNumber = String(sequenceNumber).padStart(2, '0'); // Pad with leading zero (e.g., 01, 02)

                    // Clean the process name for file naming, allowing Japanese characters
                    // This regex keeps alphanumeric characters, underscore, and common Japanese character ranges.
                    const cleanedProcessName = photo.process.replace(/[^a-zA-Z0-9_\u3040-\u309F\u30A0-\u30FF\u4E00-\u9FAF]/g, '');

                    let newFileNameBase = `${sequenceNumber}_${cleanedProcessName}`;
                    let finalFileName = `${newFileNameBase}.jpg`;
                    let counter = 1;

                    // Check for filename conflicts and append a counter if necessary
                    while (generatedFileNames[finalFileName]) {
                        counter++;
                        finalFileName = `${newFileNameBase}_${counter}.jpg`;
                    }
                    generatedFileNames[finalFileName] = true; // Mark this filename as used

                    // ★★★ ここから変更 ★★★
                    // オリジナル画像をZIPに追加
                    if (photo.originalSrc) {
                        const originalBase64Data = photo.originalSrc.split(',')[1];
                        originalImgFolder.file(finalFileName, originalBase64Data, { base64: true });
                    } else {
                        console.warn(`Original image data not found for photo ID: ${photo.id}. Skipping original file for this photo.`);
                    }

                    // 看板付き画像をZIPに追加
                    const processedBase64Data = photo.processedSrc.split(',')[1];
                    processedImgFolder.file(finalFileName, processedBase64Data, { base64: true });
                    // ★★★ ここまで変更 ★★★

                } catch (error) {
                    console.error(`Error adding image to zip for process ${photo.process}:`, error);
                    // Optionally, show a message for failed image inclusion
                }
            }

            const zipFileName = `施工写真_${currentDateInput.value || '日付不明'}_${siteNameInput.value || '現場名不明'}.zip`;

            zip.generateAsync({ type: "blob" })
                .then(function (content) {
                    saveAs(content, zipFileName); // Use FileSaver.js to save the blob
                    hideMessageBox();
                    showMessageBox('ZIPファイルの生成が完了しました！');
                })
                .catch(function (error) {
                    console.error("Error generating ZIP:", error);
                    showMessageBox('ZIPファイルの生成中にエラーが発生しました。');
                })
                .finally(() => {
                    generatePdfBtn.disabled = false;
                    exportExcelBtn.disabled = false;
                    downloadZipBtn.disabled = false;
                });
        }

        /**
         * Adds a new sequential lot number (e.g., "1号棟", "2号棟").
         */
        function addLotNumber() {
            let maxLotNum = 0;
            lotNumberOptions.forEach(lot => {
                const match = lot.match(/(\d+)号棟/);
                if (match) {
                    const num = parseInt(match[1]);
                    if (!isNaN(num) && num > maxLotNum) {
                        maxLotNum = num;
                    }
                }
            });
            const newLotNum = maxLotNum + 1;
            if (newLotNum <= 10) { // Limit to 10棟
                const newLot = `${newLotNum}号棟`;
                lotNumberOptions.add(newLot);
                updateDatalist(lotNumberDatalist, lotNumberOptions);
                updateDatalist(lotNumberFilterDatalist, lotNumberOptions);
                lotNumberInput.value = newLot; // Set the new lot as current
                updateProcessUploadListPreviews(); // Update previews for the new lot
                updateCurrentLotDisplay(); // Update the display text for current lot
                saveAppData(); // Save data after adding lot number
                showMessageBox(`${newLot} を追加しました。`);
            } else {
                showMessageBox('10号棟までしか自動追加できません。');
            }
        }

        /**
         * Clears all photo data and resets inputs.
         */
        function clearAllData() {
            showConfirmBox('全ての写真データと入力情報をクリアします。よろしいですか？\n(工程リストはクリアされません)', (confirmed) => {
                if (confirmed) {
                    photos = []; // Clear photo array
                    displayedPhotos = []; // Clear displayedPhotos array

                    // Clear lot number options
                    lotNumberOptions.clear();
                    updateDatalist(lotNumberDatalist, lotNumberOptions);
                    updateDatalist(lotNumberFilterDatalist, lotNumberOptions);

                    // Clear local storage for photos and lot numbers
                    localStorage.removeItem('photos');
                    localStorage.removeItem('lotNumberOptions');
                    localStorage.removeItem('siteName');
                    localStorage.removeItem('workType');
                    localStorage.removeItem('companyName');
                    localStorage.removeItem('designDimension');
                    localStorage.removeItem('currentDate');
                    localStorage.removeItem('lotNumber');


                    // Reset input fields
                    siteNameInput.value = '新規工事現場';
                    workTypeInput.value = '';
                    currentDateInput.valueAsDate = new Date();
                    companyNameInput.value = '株式会社JFDエンジニアリング'; // Reset to default
                    lotNumberInput.value = ''; // Reset to empty for "単棟"
                    designDimensionInput.value = 'φ600 L=m'; // Reset to default

                    // Reset filters
                    filterDateInput.value = '';
                    filterProcessInput.value = '';
                    filterLotNumberInput.value = '';

                    // Re-initialize UI
                    initializeProcessUploadList(); // Re-render process upload list (shows "写真なし")
                    renderPhotoList(); // Re-render main photo list (shows "no photos message")
                    updateCurrentLotDisplay(); // Update current lot display

                    showMessageBox('全てのデータがクリアされました。');
                }
            });
        }

        // --- App Initialization ---
        // Load data on startup
        loadAppData();

        // Set default values if nothing loaded from storage AND input is empty
        if (!siteNameInput.value) siteNameInput.value = '新規工事現場';
        // companyNameInput and designDimensionInput are already set with defaults in HTML if not loaded
        if (!currentDateInput.value) currentDateInput.valueAsDate = new Date();
        // lotNumberInput is loaded or remains empty for "単棟"
    </script>
</body>
</html>